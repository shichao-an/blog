<?xml version="1.0" encoding="utf-8"?>
<rss version="2.0">
    <channel>
        <title>Shichao's Blog</title>
        <link>https://blog.shichao.io/</link>
        <description>Recording molecular stuff</description>
        <language>en-us</language>
        <pubDate>Fri, 17 Apr 2015 00:00:00 -0700</pubDate>
        
        <item>
            <link>https://blog.shichao.io/2015/04/17/setup_openldap_server_with_openssh_lpk_on_ubuntu.html</link>
            <guid>https://blog.shichao.io/2015/04/17/setup_openldap_server_with_openssh_lpk_on_ubuntu.html</guid>
            <title><![CDATA[Setup OpenLDAP server with OpenSSH-LPK on Ubuntu 14.04]]></title>
            <description><![CDATA[<h1>Setup OpenLDAP server with OpenSSH-LPK on Ubuntu 14.04</h1>
<p>This post documents how to setup a secure OpenLDAP server that is able to make OpenLDAP client servers accept authorized SSH access requests from users.
The following steps assume the OpenLDAP server (slapd) and phpLDAPadmin are installed as referenced in the <a class="reference external" href="https://www.digitalocean.com/community/tutorials/how-to-install-and-configure-a-basic-ldap-server-on-an-ubuntu-12-04-vps">initial setup</a>.</p>
<div class="section" id="instructions-and-references">
<h2>Instructions and references</h2>
<ul class="simple">
<li><a class="reference external" href="https://www.digitalocean.com/community/tutorials/how-to-install-and-configure-a-basic-ldap-server-on-an-ubuntu-12-04-vps">Initial setup</a></li>
<li><a class="reference external" href="https://code.google.com/p/openssh-lpk/">OpenSSH-LPK</a> and <a class="reference external" href="https://github.com/jirutka/ssh-ldap-pubkey">ssh-ldap-pubkey</a> (on LDAP clients)</li>
<li><a class="reference external" href="http://lucor.github.io/post/ubuntu-and-ldap-force-authentication-during-a-bind-request/">Force authentication</a></li>
<li><a class="reference external" href="http://rogermoffatt.com/2011/08/24/ubuntu-openldap-with-ssltls/">Secure LDAP with SSL/TLS</a></li>
</ul>
</div>
<div class="section" id="understanding-cn-config-ldap-database">
<h2>Understanding cn=config (LDAP database)</h2>
<p>The default installation of OpenLDAP in recent versions of Ubuntu uses the new <a class="reference external" href="https://help.ubuntu.com/community/OpenLDAPServer#Installation">runtime configuration (RTC)
system</a> or olc (OpenLDAP Configuration). This installation uses <span class="docutils literal"><span class="pre">cn=config</span></span> (the LDAP database) for configuration rather than the old style <span class="docutils literal"><span class="pre">slapd.conf</span></span>.</p>
</div>
<div class="section" id="schemas">
<h2>Schemas</h2>
<p>The schemas can be imported dynamically into <span class="docutils literal"><span class="pre">cn=config</span></span> database, without restarting <span class="docutils literal"><span class="pre">slapd</span></span>. The schemas to be imported can placed in
<span class="docutils literal"><span class="pre">/etc/ldap/schema</span></span>.</p>
<p>The following schema in ldif format will be used and discussed in the subsequent sections:</p>
<ul class="simple">
<li><span class="docutils literal"><span class="pre">openssh-lpk.ldif</span></span></li>
<li><span class="docutils literal"><span class="pre">ldap_disable_bind_anon.ldif</span></span></li>
<li><span class="docutils literal"><span class="pre">ssl.ldif</span></span></li>
</ul>
</div>
<div class="section" id="import-openssh-lpk-scheme">
<h2>Import openssh-lpk scheme</h2>
<div class="highlight-python"><div class="highlight"><pre>ldapadd -Y EXTERNAL -H ldapi:/// -f openssh-lpk.ldif
</pre></div>
</div>
<p>where <span class="docutils literal"><span class="pre">openssh-lpk.ldif</span></span> is:</p>
<div class="highlight-python"><div class="highlight"><pre>dn: cn=openssh-lpk,cn=schema,cn=config
objectClass: olcSchemaConfig
cn: openssh-lpk
olcAttributeTypes: ( 1.3.6.1.4.1.24552.500.1.1.1.13 NAME 'sshPublicKey'
  DESC 'MANDATORY: OpenSSH Public key'
  EQUALITY octetStringMatch
  SYNTAX 1.3.6.1.4.1.1466.115.121.1.40 )
olcObjectClasses: ( 1.3.6.1.4.1.24552.500.1.1.2.0 NAME 'ldapPublicKey' SUP top AUXILIARY
  DESC 'MANDATORY: OpenSSH LPK objectclass'
  MAY ( sshPublicKey $ uid )
  )
</pre></div>
</div>
</div>
<div class="section" id="force-authentication">
<h2>Force authentication</h2>
<p>By default, OpenLDAP allows anonymous query from any client servers. You may want to enable authentication so that only authenticated clients are able to query the server:</p>
<div class="highlight-python"><div class="highlight"><pre>ldapadd -Y EXTERNAL -H ldapi:/// -f ldap_disable_bind_anon.ldif
</pre></div>
</div>
<p>where <span class="docutils literal"><span class="pre">ldap_disable_bind_anon.ldif</span></span> is:</p>
<div class="highlight-python"><div class="highlight"><pre>dn: cn=config
changetype: modify
add: olcDisallows
olcDisallows: bind_anon

dn: cn=config
changetype: modify
add: olcRequires
olcRequires: authc

dn: olcDatabase={-1}frontend,cn=config
changetype: modify
add: olcRequires
olcRequires: authc
</pre></div>
</div>
<p class="readmorewrapper"><a class="readmore" href="https://blog.shichao.io/2015/04/17/setup_openldap_server_with_openssh_lpk_on_ubuntu.html#more">Read more...</a></p></div>
 
 
 
 
 
 
 
]]></description>
             <pubDate>Fri, 17 Apr 2015 00:00:00 -0700</pubDate>
        </item>
    
        <item>
            <link>https://blog.shichao.io/2015/01/06/tunneling_rdp_over_ssh_with_xrdp_and_xfreerdp.html</link>
            <guid>https://blog.shichao.io/2015/01/06/tunneling_rdp_over_ssh_with_xrdp_and_xfreerdp.html</guid>
            <title><![CDATA[Tunneling RDP over SSH with xrdp and xfreerdp]]></title>
            <description><![CDATA[<h1>Tunneling RDP over SSH with xrdp and xfreerdp</h1>
<p>Suppose you have a remote desktop but you only have SSH access and you need to connect to that desktop with GUI. For example, you have a server at home and you’ve setup port forwarding on your router so that you can SSH to your that home server from office or school, and you don’t want to expose too many ports to the Internet. You can setup xrdp server and tunnel your connection over SSH.</p>
<p>In the following texts, the home server is Fedora 20 and the client laptop is OS X Yosemite.</p>
<div class="section" id="install-xrdp-on-home-server">
<h2>Install xrdp on home server</h2>
<p>On your home server, run:</p>
<div class="highlight-shell-session"><div class="highlight"><pre><span class="go"># yum install xrdp</span>
<span class="go"># systemctl start xrdp.service</span>
<span class="go"># systemctl enable xrdp.service</span>
</pre></div>
</div>
</div>
<div class="section" id="configure-firewall">
<h2>Configure firewall</h2>
<p>Add SSH service and open port 3389 to the current zone and make it permanent. By opening port 3389, you can connect directly to the home server without SSH when your laptop is in the same network at home.</p>
<div class="highlight-shell-session"><div class="highlight"><pre><span class="go"># firewall-cmd --add-service=ssh --permanent</span>
<span class="go"># firewall-cmd --add-port=3389/tcp --permanent</span>
<span class="go"># firewall-cmd --reload</span>
</pre></div>
</div>
</div>
<div class="section" id="install-xfreerdp-using-homebrew">
<h2>Install xfreerdp using homebrew</h2>
<p>Make sure you’ve installed XQuartz. You can download the dmg at <a class="reference external" href="http://xquartz.macosforge.org/landing/">http://xquartz.macosforge.org/landing/</a> .</p>
<p>On your OS X laptop:</p>
<div class="highlight-shell-session"><div class="highlight"><pre><span class="go">$ brew update</span>
<span class="go">$ brew install freerdp</span>
</pre></div>
</div>
</div>
<div class="section" id="start-ssh-forwarding">
<h2>Start SSH forwarding</h2>
<p>After you make sure you can SSH to your home server (say 1.1.1.1), you can start SSH forwarding. Run the following command in one terminal session:</p>
<div class="highlight-shell-session"><div class="highlight"><pre><span class="go">$ ssh -qnN -L 3389:127.0.0.1:3389 1.1.1.1</span>
</pre></div>
</div>
</div>
<div class="section" id="connect-to-home-server-using-xfreerdp">
<h2>Connect to home server using xfreerdp</h2>
<div class="highlight-shell-session"><div class="highlight"><pre><span class="go">$ xfreerdp localhost</span>
</pre></div>
</div>
<p>Then, you should have a X11 window show up as in the screenshot below. Enter your username and password to login to your home server.</p>
<p><a class="reference internal" href="https://blog.shichao.io/_images/xquartz-freerdp.png"><img alt="s1" src="https://blog.shichao.io/_images/xquartz-freerdp.png" style="width: 450px;"/></a></p>
</div>
]]></description>
             <pubDate>Tue, 06 Jan 2015 00:00:00 -0800</pubDate>
        </item>
    
        <item>
            <link>https://blog.shichao.io/2014/12/22/rabbitmq_clustering_and_high_availability_on_ubuntu_ec2_servers.html</link>
            <guid>https://blog.shichao.io/2014/12/22/rabbitmq_clustering_and_high_availability_on_ubuntu_ec2_servers.html</guid>
            <title><![CDATA[RabbitMQ clustering and high availability on Ubuntu EC2 servers]]></title>
            <description><![CDATA[<h1>RabbitMQ clustering and high availability on Ubuntu EC2 servers</h1>
<div class="section" id="sample">
<h2>Sample</h2>
<p>The following setup and configurations were performed on the production servers listed below:</p>
<ul class="simple">
<li>mq-node1.example.com</li>
<li>mq-node2.example.com</li>
<li>mq-node3.example.com</li>
</ul>
</div>
<div class="section" id="installation">
<h2>Installation</h2>
<div class="highlight-shell-session"><div class="highlight"><pre><span class="go"># apt-get install rabbitmq-server</span>
</pre></div>
</div>
</div>
<div class="section" id="hostname-and-etc-hosts">
<h2>Hostname and /etc/hosts</h2>
<p>On each server, the first priority of setup is hostname and <span class="docutils literal"><span class="pre">/etc/hosts</span></span> for internal IP addresses, which are used by RabbitMQ (Erlang) nodes. Use this script (<a class="reference external" href="https://gist.github.com/shichao-an/7c43e22c21c666f384ef">set-hostname.sh</a>) to set the hostname for the corresponding server with the command:</p>
<div class="highlight-text"><div class="highlight"><pre># ./set-hostname.sh -s mq-nodeN.example.com
</pre></div>
</div>
<p>Then, modify <span class="docutils literal"><span class="pre">/etc/hosts</span></span> so that it looks like this (e.g. on mq-node1.example.com):</p>
<div class="highlight-text"><div class="highlight"><pre>127.0.1.1 mq-node1.example.com mq-node1
10.0.1.101 mq-node2
10.0.1.102 mq-node3
</pre></div>
</div>
</div>
<div class="section" id="ports">
<h2>Ports</h2>
<p>Make sure port 5672 (AMQP) and 45000 (we’ll use this later) are open on each server.</p>
</div>
<div class="section" id="config-files">
<h2>Config files</h2>
<p>On each server, do the following:</p>
<p>Edit <span class="docutils literal"><span class="pre">/etc/rabbitmq/rabbitmq-env.conf</span></span> and add the following (port configuration):</p>
<div class="highlight-text"><div class="highlight"><pre>SERVER_START_ARGS="-kernel inet_dist_listen_min 45000 -kernel inet_dist_listen_max 45000"
</pre></div>
</div>
<p>Edit <span class="docutils literal"><span class="pre">/etc/rabbitmq/rabbitmq.config</span></span> and add the following (clustering configuration):</p>
<div class="highlight-text"><div class="highlight"><pre>[{rabbit,
[{cluster_nodes, {['rabbit@mq-node1', 'rabbit@mq-node2', 'rabbit@mq-node3'], disc}}]}].
</pre></div>
</div>
<p>Edit <span class="docutils literal"><span class="pre">/var/lib/rabbitmq/.erlang.cookie</span></span> and make sure they are the same on each server.</p>
</div>
<div class="section" id="reset-and-start-nodes">
<h2>Reset and start nodes</h2>
<p>The RabbitMQ nodes may be already in running state. To put new configuration in effect, we have to reset and restart:
First, we reset and stop each node:</p>
<div class="highlight-shell-session"><div class="highlight"><pre><span class="go"># rabbitmqctl stop_app; rabbitmqctl reset;  rabbitmqctl stop</span>
</pre></div>
</div>
<p>Then, start each node in turn. Remember, do this IN TURN, not simultaneously:</p>
<div class="highlight-shell-session"><div class="highlight"><pre><span class="go"># service rabbitmq start</span>
</pre></div>
</div>
<p class="readmorewrapper"><a class="readmore" href="https://blog.shichao.io/2014/12/22/rabbitmq_clustering_and_high_availability_on_ubuntu_ec2_servers.html#more">Read more...</a></p></div>
 
 
 
 
 
 
 
 
]]></description>
             <pubDate>Mon, 22 Dec 2014 00:00:00 -0800</pubDate>
        </item>
    
        <item>
            <link>https://blog.shichao.io/2014/12/18/serving_local_filesystem_using_nginx_on_os_x.html</link>
            <guid>https://blog.shichao.io/2014/12/18/serving_local_filesystem_using_nginx_on_os_x.html</guid>
            <title><![CDATA[Serving local filesystem using nginx on OS X]]></title>
            <description><![CDATA[<h1>Serving local filesystem using nginx on OS X</h1>
<p>Sometimes you may want to access certain files on one computer from other LAN clients using web browsers, for example, a directory of PDF files, or some MP4/MOV videos that can be easily streamed through <a class="reference external" href="http://www.w3schools.com/html/html5_video.asp">HTML5 Video</a>.</p>
<p>To make things easy, we can set up an nginx server with <a class="reference external" href="https://github.com/aperezdc/ngx-fancyindex">Nginx Fancy Index module</a> to serve certain directories on one or more filesystems on your OS X system.</p>
<p>We can install all required software using homebrew and we need to do some hacks on the forumla. The following setup were tested on OS X 10.10.</p>
<p>First, tap <a class="reference external" href="https://github.com/Homebrew/homebrew-nginx">homebrew-nginx</a>:</p>
<div class="highlight-shell-session"><div class="highlight"><pre><span class="go">$ brew tap homebrew/nginx</span>
</pre></div>
</div>
<p>As of writing, the version of fancyindex-nginx-module provided by this formula is 0.3.2, but we need 0.3.3 which <a class="reference external" href="http://wiki.nginx.org/NgxFancyIndex">allows sorting elements by name (default), modification time</a>. So we need to edit the formula file:</p>
<div class="highlight-shell-session"><div class="highlight"><pre><span class="go">$ brew edit fancyindex-nginx-module</span>
</pre></div>
</div>
<p>Or, use a text editor to open the formula file:</p>
<div class="highlight-shell-session"><div class="highlight"><pre><span class="go">$ vim /usr/local/Library/Taps/homebrew/homebrew-nginx/Formula/fancyindex-nginx-module.rb</span>
</pre></div>
</div>
<p>and change <span class="docutils literal"><span class="pre">https://github.com/aperezdc/ngx-fancyindex/archive/v0.3.2.tar.gz</span></span> into <span class="docutils literal"><span class="pre">https://github.com/aperezdc/ngx-fancyindex/archive/v0.3.3.tar.gz</span></span>.</p>
<p>Then, install nginx by building with the Fancy Index Module:</p>
<div class="highlight-shell-session"><div class="highlight"><pre><span class="go">$ brew install nginx-full --with-fancyindex-module</span>
</pre></div>
</div>
<p>If brew complains about SHA1 error, then you have to modify the <span class="docutils literal"><span class="pre">sha1</span></span> value of the previous fomula to match the actual sha1 in the error output.</p>
<p>Download <a class="reference external" href="https://github.com/TheInsomniac/Nginx-Fancyindex-Theme">FancyIndex Theme</a> to <span class="docutils literal"><span class="pre">/usr/local/etc/nginx/fancyindex</span></span>:</p>
<div class="highlight-shell-session"><div class="highlight"><pre><span class="go">$ git clone https://github.com/TheInsomniac/Nginx-Fancyindex-Theme.git /usr/local/etc/nginx/fancyindex</span>
</pre></div>
</div>
<p>All that remains to be done is configuration. Assume you want to serve <span class="docutils literal"><span class="pre">/path/to/movies</span></span> and <span class="docutils literal"><span class="pre">/another/path/to/pdf</span></span> directories, you can use alias <span class="docutils literal"><span class="pre">movies</span></span> and <span class="docutils literal"><span class="pre">pdf</span></span> to point to these locations. Edit <span class="docutils literal"><span class="pre">/usr/local/etc/nginx/nginx.conf</span></span> and modify the <span class="docutils literal"><span class="pre">server</span></span> block under <span class="docutils literal"><span class="pre">http</span></span> block:</p>
<div class="highlight-nginx"><div class="highlight"><pre><span class="k">server</span> <span class="p">{</span>
    <span class="kn">listen</span>       <span class="mi">8080</span><span class="p">;</span>
    <span class="kn">server_name</span>  <span class="s">localhost</span><span class="p">;</span>

    <span class="kn">fancyindex</span> <span class="no">on</span><span class="p">;</span>
    <span class="kn">fancyindex_exact_size</span> <span class="no">off</span><span class="p">;</span>
    <span class="kn">fancyindex_localtime</span> <span class="no">on</span><span class="p">;</span>
    <span class="kn">fancyindex_header</span> <span class="s">"/fancyindex/header.html"</span><span class="p">;</span>
    <span class="kn">fancyindex_footer</span> <span class="s">"/fancyindex/footer.html"</span><span class="p">;</span>
    <span class="kn">fancyindex_ignore</span> <span class="s">"fancyindex"</span><span class="p">;</span>

    <span class="kn">location</span> <span class="s">/movies</span> <span class="p">{</span>
        <span class="kn">alias</span> <span class="s">/path/to/movies/</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kn">location</span> <span class="s">/pdf</span> <span class="p">{</span>
        <span class="kn">alias</span> <span class="s">/another/path/to/pdf/</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kn">location</span> <span class="s">/fancyindex/</span> <span class="p">{</span>
        <span class="kn">alias</span> <span class="s">/usr/local/etc/nginx/fancyindex/</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The config above is just a minimum configuration. You may add extra configurations (e.g. <span class="docutils literal"><span class="pre">error_log</span></span>, <span class="docutils literal"><span class="pre">error_page</span></span>) according to your need. Note the paths for the <span class="docutils literal"><span class="pre">alias</span></span> directives, there must be trailing slashes, such as <span class="docutils literal"><span class="pre">alias</span> <span class="pre">/path/to/movies/</span></span>.</p>
<p>Start nginx:</p>
<div class="highlight-shell-session"><div class="highlight"><pre><span class="go">$ nginx</span>
</pre></div>
</div>
<p>If you make any changes to the <span class="docutils literal"><span class="pre">nginx.conf</span></span>, remember to reload:</p>
<div class="highlight-shell-session"><div class="highlight"><pre><span class="go">$ nginx -s reload</span>
</pre></div>
</div>
<p>You can check whether the port 8080 is in the LISTEN state:</p>
<div class="highlight-shell-session"><div class="highlight"><pre><span class="go">$ sudo netstat -anf inet -p tcp | grep LISTEN</span>
</pre></div>
</div>
<p>Finally, if you want to keep your firewall on and nginx trusted, run the following command:</p>
<div class="highlight-shell-session"><div class="highlight"><pre><span class="go">$ brew install coreutils</span>
<span class="go">$ sudo /usr/libexec/ApplicationFirewall/socketfilterfw --add $(greadlink -f /usr/local/bin/nginx)</span>
</pre></div>
</div>
<p>You can test from local <a class="reference external" href="http://127.0.0.1:8080/movies">http://127.0.0.1:8080/movies</a> as well as <a class="reference external" href="http://youripaddress:8080/movies">http://youripaddress:8080/movies</a> and <a class="reference external" href="http://youripaddress:8080/pdf">http://youripaddress:8080/pdf</a> from a browser on your LAN clients.</p>
<p><a class="reference internal" href="https://blog.shichao.io/_images/nginx-fancyindex.png"><img alt="s1" src="https://blog.shichao.io/_images/nginx-fancyindex.png" style="width: 450px;"/></a></p>
]]></description>
             <pubDate>Thu, 18 Dec 2014 00:00:00 -0800</pubDate>
        </item>
    
        <item>
            <link>https://blog.shichao.io/2014/10/01/setup_virtualenvwrapper_with_pyenv_using_pyenv_virtualenvwrapper.html</link>
            <guid>https://blog.shichao.io/2014/10/01/setup_virtualenvwrapper_with_pyenv_using_pyenv_virtualenvwrapper.html</guid>
            <title><![CDATA[Setup virtualenvwrapper with pyenv using pyenv-virtualenvwrapper]]></title>
            <description><![CDATA[<h1>Setup virtualenvwrapper with pyenv using pyenv-virtualenvwrapper</h1>
<p>Typically on OS X, I’m prone to use <a class="reference external" href="https://github.com/yyuu/pyenv">pyenv</a> to manage multiple Python versions, particularly 2.7 and 3.3. I always keep the 2.7.x Python (system version) that ships with OS X, and install extra versions using pyenv, and develop under virtualenvs. It seems <a class="reference external" href="https://github.com/pypa/virtualenv/">virtualenv</a> and <a class="reference external" href="https://bitbucket.org/dhellmann/virtualenvwrapper/">virtualenvwrapper</a> do not natively work well with pyenv’s shims when creating new virtualenvs, and it also seems the author of pyenv already gives the solution, <a class="reference external" href="https://github.com/yyuu/pyenv-virtualenvwrapper">pyenv-virtualenvwrapper</a>.</p>
<p>As an essential record, install Python 3.4.1 using pyenv (for installation of pyenv itself, see its <a class="reference external" href="https://github.com/yyuu/pyenv">documentation</a>) and enable it globally, along with the system version.</p>
<div class="highlight-shell-session"><div class="highlight"><pre><span class="go">$ pyenv install 3.4.1</span>
<span class="go">$ pyenv rehash</span>
<span class="go">$ pyenv global system 3.4.1</span>
</pre></div>
</div>
<p>You can verify current available versions using the following command:</p>
<div class="highlight-shell-session"><div class="highlight"><pre><span class="go">$ pyenv versions</span>
<span class="go">* system (set by /Users/shichao/.python-version)</span>
<span class="go">* 3.4.1 (set by /Users/shichao/.python-version)</span>
</pre></div>
</div>
<p>Make sure you have installed virtualenvwrapper and pyenv-virtualenvwrapper (using brew, of course):</p>
<div class="highlight-shell-session"><div class="highlight"><pre><span class="go">$ pip install virtualenvwrapper</span>
<span class="go">$ brew install pyenv-virtualenvwrapper</span>
</pre></div>
</div>
<p>Then, put the following lines somewhere in your <span class="docutils literal"><span class="pre">~/.bash_profile</span></span>:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="c"># pyenv</span>
<span class="nb">eval</span> <span class="s2">"</span><span class="k">$(</span>pyenv init -<span class="k">)</span><span class="s2">"</span>
<span class="c"># virtualenvwrapper</span>
<span class="nb">export </span><span class="nv">WORKON_HOME</span><span class="o">=</span>~/envs
</pre></div>
</div>
<p>Then you can enable virtualenvwrapper with <span class="docutils literal"><span class="pre">pyenv</span> <span class="pre">virtualenvwrapper</span></span>, and you may set an alias for that.</p>
<p>Now, you can normally create new virtualenvs.</p>
<p>Create a virtualenv from the system version:</p>
<div class="highlight-shell-session"><div class="highlight"><pre><span class="go">$ mkvirtualenv env1 -p $(which python)</span>
</pre></div>
</div>
<p>Similarly, create a virtualenv from 3.4:</p>
<div class="highlight-shell-session"><div class="highlight"><pre><span class="go">$ mkvirtualenv env2 -p $(which python3.4)</span>
</pre></div>
</div>
]]></description>
             <pubDate>Wed, 01 Oct 2014 00:00:00 -0700</pubDate>
        </item>
    
        <item>
            <link>https://blog.shichao.io/2014/05/02/fixing_mongodb_against_unclean_shutdown.html</link>
            <guid>https://blog.shichao.io/2014/05/02/fixing_mongodb_against_unclean_shutdown.html</guid>
            <title><![CDATA[Fixing MongoDB against unclean shutdown]]></title>
            <description><![CDATA[<h1>Fixing MongoDB against unclean shutdown</h1>
<p>It’s been a while since I maintained one of my servers that host an old project. After I got an HTTP 500 in an occasional case, I logged in to check what happened, only to find MongoDB is down. Running <span class="docutils literal"><span class="pre">service</span> <span class="pre">mongod</span> <span class="pre">restart</span></span> does not work. The MongoDB log indicates “Unclean shutdown detected.”</p>
<p>After a search on Google, here’s what I did to fix that:</p>
<div class="highlight-shell-session"><div class="highlight"><pre><span class="go"># grep dbpath /etc/mongod.conf</span>
<span class="go">dbpath=/var/lib/mongo</span>
<span class="go"># rm /var/lib/mongo/mongod.lock</span>
<span class="go"># mongod --repair --dbpath /var/lib/mongo</span>
</pre></div>
</div>
<p>At this point, you will see that MongoDB is running the repair process. If you immediately start MongoDB server after that, it still fails, because some permissions in /var/lib/mongo have been changed. You have to recover owner and group of those files back to “mongod” and then start the service:</p>
<div class="highlight-shell-session"><div class="highlight"><pre><span class="go"># chown -R mongod:mongod /var/lib/mongo</span>
<span class="go"># service mongod restart</span>
</pre></div>
</div>
<p>Finally note that this is an CentOS server. If you use MongoDB on Ubuntu, some namings may be different.</p>
]]></description>
             <pubDate>Fri, 02 May 2014 00:00:00 -0700</pubDate>
        </item>
    
        <item>
            <link>https://blog.shichao.io/2014/05/01/get_number_of_bits_of_a_python_integer.html</link>
            <guid>https://blog.shichao.io/2014/05/01/get_number_of_bits_of_a_python_integer.html</guid>
            <title><![CDATA[Get number of bits of a Python integer]]></title>
            <description><![CDATA[<h1>Get number of bits of a Python integer</h1>
<p>A Python integer is represented as either of 32-bit or 64-bit signed integer type that is platform-specific, without considering it as <a class="reference external" href="https://docs.python.org/2.7/c-api/int.html">an Python object</a>. As indicated in the documentation, whether it is 32-bit or 64-bit can be revealed by checking <span class="docutils literal"><span class="pre">sys.maxsize</span></span> (or <span class="docutils literal"><span class="pre">sys.maxint</span></span> on older CPython implementations such as 2.4), the value of which “is the largest positive integer supported by the platform’s <span class="docutils literal"><span class="pre">Py_ssize_t</span></span> type and is usually <span class="docutils literal"><span class="pre">2**31</span> <span class="pre">-</span> <span class="pre">1</span></span> on a 32-bit platform and <span class="docutils literal"><span class="pre">2**63</span> <span class="pre">-</span> <span class="pre">1</span></span> on a 64-bit platform”. <a class="reference external" href="https://docs.python.org/2/library/sys.html">[1]</a> <a class="reference external" href="https://docs.python.org/3/library/sys.html#sys.maxsize">[2]</a>.</p>
<p>The following function helps determine number of bits of an integer and returns either 64 or 32 by leveraging the variable discussed above:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">sys</span>


<span class="k">def</span> <span class="nf">get_int_bits</span><span class="p">():</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">sys</span><span class="p">,</span> <span class="s">'maxsize'</span><span class="p">):</span>
        <span class="n">max_int</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">sys</span><span class="p">,</span> <span class="s">'maxsize'</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">max_int</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">sys</span><span class="p">,</span> <span class="s">'maxint'</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">max_int</span> <span class="o">&gt;&gt;</span> <span class="mi">62</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">32</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">64</span>
</pre></div>
</div>
<p>Check out the code on GitHub Gist from <a class="reference external" href="https://gist.github.com/shichao-an/b447d24f0a5381b0fa92">this link</a>.</p>
<p><strong>Updated Jun 10, 2014</strong></p>
<p>After an exploration of the <a class="reference external" href="https://docs.python.org/2/library/stdtypes.html#int.bit_length">built-in types</a>, it is clear that <span class="docutils literal"><span class="pre">int.bit_length</span></span> can be used more easily than bit manipulation.:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">sys</span>


<span class="k">def</span> <span class="nf">get_int_bits</span><span class="p">():</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">sys</span><span class="p">,</span> <span class="s">'maxsize'</span><span class="p">):</span>
        <span class="n">max_int</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">sys</span><span class="p">,</span> <span class="s">'maxsize'</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">max_int</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">sys</span><span class="p">,</span> <span class="s">'maxint'</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">max_int</span><span class="o">.</span><span class="n">bit_length</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span>
</pre></div>
</div>
]]></description>
             <pubDate>Thu, 01 May 2014 00:00:00 -0700</pubDate>
        </item>
    
        <item>
            <link>https://blog.shichao.io/2014/04/09/using_bash_arrays_and_ifs_to_manipulate_filenames.html</link>
            <guid>https://blog.shichao.io/2014/04/09/using_bash_arrays_and_ifs_to_manipulate_filenames.html</guid>
            <title><![CDATA[Using Bash arrays and IFS to manipulate filenames]]></title>
            <description><![CDATA[<h1>Using Bash arrays and IFS to manipulate filenames</h1>
<p>Assume we want to work with files in a directory. The most intuitive way is to make use of filename expansion, using globbing. We can use the <cite>for construct</cite> and wildcard <span class="docutils literal"><span class="pre">*</span></span> to handle each file nice and clean, without worrying about those filenames that contain whitespaces (suppose that in all of the following context, the working directory contain three files: “Foo”, “Bar”, and “Foo Bar”):</p>
<div class="highlight-shell-session"><div class="highlight"><pre><span class="go">$ for file in *; do echo "$file"; done</span>
</pre></div>
</div>
<p>We can also create an array from these filenames, using the following command:</p>
<div class="highlight-shell-session"><div class="highlight"><pre><span class="go">$ files=(*)</span>
</pre></div>
</div>
<p>Then, we can take a look at both the attributes and the value of <cite>files</cite>:</p>
<div class="highlight-shell-session"><div class="highlight"><pre><span class="go">$ declare -p files</span>
<span class="go">declare -a files='([0]="Bar" [1]="Foo" [2]="Foo Bar")'</span>
</pre></div>
</div>
<p>What if we want to create an array with specific orders, say by modification time (<cite>mtime</cite>) of files. We have to use the <span class="docutils literal"><span class="pre">ls</span></span> with the <span class="docutils literal"><span class="pre">-t</span></span> switch.  Now there are several practical scenarios discussed as follows.</p>
<ol class="arabic">
<li><p class="first">Get the latest modified filename:</p>
<div class="highlight-shell-session"><div class="highlight"><pre><span class="go">$ filename=$(ls -t | head -1)</span>
</pre></div>
</div>
</li>
<li><p class="first">Create an array of filenames ordered by their <cite>mtime</cite>. Clearly, globbing will not work because it is based on filename pattern matching. We have to use both command substitution and word splitting. Let’s try the following first:</p>
<div class="highlight-shell-session"><div class="highlight"><pre><span class="go">$ filenames=($(ls -t))</span>
<span class="go">$ declare -p filenames</span>
<span class="go">declare -a filenames='([0]="Foo" [1]="Bar" [2]="Bar" [3]="Foo")'</span>
</pre></div>
</div>
<p>Clearly this is not the result we want since the whitespace-contained filename is corrupted.</p>
<p>We need to hack a little on IFS variable. Let’s try what happens if we disable word splitting by setting IFS to null:</p>
<div class="highlight-shell-session"><div class="highlight"><pre><span class="go">$ IFS=</span>
<span class="go">$ filenames=($(ls -t))</span>
<span class="go">$ declare -p filenames</span>
<span class="go">declare -a filenames='([0]="Foo Bar</span>
<span class="go">Bar</span>
<span class="go">Foo")'</span>
</pre></div>
</div>
<p>It seems it’s getting worse this time. Since word splitting is not performed, the result of command substitution becomes an single word.</p>
<p>We know that the result of <span class="docutils literal"><span class="pre">ls</span></span> command is multiple lines of filenames. As the result of command substitution (i.e. <span class="docutils literal"><span class="pre">$(ls</span> <span class="pre">-t)</span></span>), the filenames are separated by newlines (<span class="docutils literal"><span class="pre">\n</span></span>). The default IFS is a sequence of <span class="docutils literal"><span class="pre">\t\n</span></span> (space, tab and newline), which means each of these characters will be used to delimit words. Here we need to suppress the effect of space; just set IFS to newline character (<span class="docutils literal"><span class="pre">\n</span></span>) (as long as your filenames does not contain newlines), with ANSI C quoting (<span class="docutils literal"><span class="pre">$''</span></span>):</p>
<div class="highlight-shell-session"><div class="highlight"><pre><span class="go">$ IFS=$'\n'</span>
<span class="go">$ filenames=($(ls -t))</span>
<span class="go">$ declare -p filenames</span>
<span class="go">declare -a filenames='([0]="Foo Bar" [1]="Bar" [2]="Foo")'</span>
</pre></div>
</div>
<p>In similar ways, we can get <cite>n</cite> most recently modified filenames, just make use of parameter expansion:</p>
<div class="highlight-shell-session"><div class="highlight"><pre><span class="go">$ echo "${filenames[@]:0:2}"  # Print two most recently modified names</span>
</pre></div>
</div>
</li>
</ol>
]]></description>
             <pubDate>Wed, 09 Apr 2014 00:00:00 -0700</pubDate>
        </item>
    
        <item>
            <link>https://blog.shichao.io/2014/04/04/bash_double_bracket_test_contructs_and_word_splitting.html</link>
            <guid>https://blog.shichao.io/2014/04/04/bash_double_bracket_test_contructs_and_word_splitting.html</guid>
            <title><![CDATA[Bash double brackets, test contructs and word splitting]]></title>
            <description><![CDATA[<h1>Bash double brackets, test contructs and word splitting</h1>
<p>We know that the double brackets constructs can be used in place of the <span class="docutils literal"><span class="pre">test</span></span> builtin (<span class="docutils literal"><span class="pre">[</span></span>) commonly used as single brackets to evaluate conditional expressions. The double brackets are preferred in terms of writing less error-prone scripts, though it is not POSIX-compliant (not portable to many other shells).</p>
<p>The primary difference of double brackets from the <span class="docutils literal"><span class="pre">test</span></span> builtin is that word splitting and filename expansion are not performed within them. It is easier to understand the filename expansion difference in this case, let’s take a look at the difference of word splitting.</p>
<ol class="arabic">
<li><p class="first">First, the following command fails because in <span class="docutils literal"><span class="pre">test</span></span> constructs the word splitting is performed after parameter expansion (and variable expansion, if any):</p>
<div class="highlight-shell-session"><div class="highlight"><pre><span class="go">$ bash -xc 'foobar="hello world"; [ $foobar = "hello world" ] &amp;&amp; echo "yes"'</span>
<span class="go">+ '[' hello world = 'hello world' ']'</span>
<span class="go">bash: line 0: [: too many arguments</span>
</pre></div>
</div>
</li>
<li><p class="first">In the double brackes, the error will not occur because word splitting is not performed, like the following:</p>
<div class="highlight-shell-session"><div class="highlight"><pre><span class="go">$ bash -xc 'foobar="hello world"; [[ $foobar = "hello world" ]] &amp;&amp; echo "yes"'</span>
<span class="go">+ foobar='hello world'</span>
<span class="go">+ [[ hello world = \h\e\l\l\o\ \w\o\r\l\d ]]</span>
<span class="go">+ echo yes</span>
<span class="go">yes</span>
</pre></div>
</div>
</li>
<li><p class="first">We can supress word splitting in the <span class="docutils literal"><span class="pre">test</span></span> construct by setting IFS to null, because when IFS is null, word splitting never occurs. This time, this command will succeed:</p>
<div class="highlight-shell-session"><div class="highlight"><pre><span class="go">$ bash -xc 'IFS=""; foobar="hello world"; [ $foobar = "hello world" ] &amp;&amp; echo "yes"'</span>
<span class="go">+ IFS=</span>
<span class="go">+ foobar='hello world'</span>
<span class="go">+ '[' 'hello world' = 'hello world' ']'</span>
<span class="go">+ echo yes</span>
<span class="go">yes</span>
</pre></div>
</div>
</li>
<li><p class="first">Another feature to note is that double brackets treat unset variables and null variable (variable whose value is a null string, i.e. ‘’)  differently from the <span class="docutils literal"><span class="pre">test</span></span> construct. For example:</p>
<div class="highlight-shell-session"><div class="highlight"><pre><span class="go">$ bash -xc 'IFS=""; foobar=""; [ $foobar = "hello world" ] &amp;&amp; echo "yes"'</span>
<span class="go">+ IFS=</span>
<span class="go">+ foobar=</span>
<span class="go">+ '[' = 'hello world' ']'</span>
<span class="go">bash: line 0: [: =: unary operator expected</span>

<span class="go">$ bash -xc 'IFS=""; foobar=""; [[ $foobar = "hello world" ]] &amp;&amp; echo "yes"'</span>
<span class="go">+ IFS=</span>
<span class="go">+ foobar=</span>
<span class="go">+ [[ '' = \h\e\l\l\o\ \w\o\r\l\d ]]</span>
</pre></div>
</div>
</li>
</ol>
<p>The unset or null variable is converted to null argument (<span class="docutils literal"><span class="pre">''</span></span>) as a result in double brackets, while in <span class="docutils literal"><span class="pre">test</span></span> constructs it is removed.</p>
<ol class="arabic" start="5">
<li><p class="first">You may notice in the second step above that the xtrace output of the conditional expression to the right of the operator is <span class="docutils literal"><span class="pre">\h\e\l\l\o\</span> <span class="pre">\w\o\r\l\d</span></span>. This is because when using operators <span class="docutils literal"><span class="pre">==</span></span>, <span class="docutils literal"><span class="pre">!=</span></span> and the POSIX version <span class="docutils literal"><span class="pre">=</span></span>, the string to the right is considered a pattern and pattern matching will be performed. The backslash indicates the each character is literal instead of pattern, because “hello world” is quoted. The following example makes the right string as pattern:</p>
<div class="highlight-shell-session"><div class="highlight"><pre><span class="go">$ bash -xc 'IFS=""; foobar="hello world"; [[ $foobar = hello* ]] &amp;&amp; echo "yes"'</span>
<span class="go">+ IFS=</span>
<span class="go">+ foobar='hello world'</span>
<span class="go">+ [[ hello world = hello* ]]</span>
<span class="go">+ echo yes</span>
<span class="go">yes</span>
</pre></div>
</div>
</li>
</ol>
]]></description>
             <pubDate>Fri, 04 Apr 2014 00:00:00 -0700</pubDate>
        </item>
    
        <item>
            <link>https://blog.shichao.io/2014/03/20/enabling_adobe_flash_player_plugin_for_google_chrome_on_fedora.html</link>
            <guid>https://blog.shichao.io/2014/03/20/enabling_adobe_flash_player_plugin_for_google_chrome_on_fedora.html</guid>
            <title><![CDATA[Enabling Adobe Flash Player plugin for Google Chrome on Fedora]]></title>
            <description><![CDATA[<h1>Enabling Adobe Flash Player plugin for Google Chrome on Fedora</h1>
<p>The Google Chrome browser I use was installed from the third-party repository by Google. The default Pepper Flash Player plugin (version 12.0) does not support some websites (such as <a class="reference external" href="http://www.bilibili.tv">www.bilibili.tv</a>). I have to install the Adobe Flash Player plugin and enable it for Google Chrome.</p>
<p>1. Install the repository from Adobe (assuming 64-bit):</p>
<div class="highlight-shell-session"><div class="highlight"><pre><span class="go"># yum install http://linuxdownload.adobe.com/adobe-release/adobe-release-x86_64-1.0-1.noarch.rpm</span>
<span class="go"># rpm --import /etc/pki/rpm-gpg/RPM-GPG-KEY-adobe-linux</span>
</pre></div>
</div>
<p>2. Install the flash-plugin package:</p>
<div class="highlight-shell-session"><div class="highlight"><pre><span class="go"># yum install flash-plugin</span>
</pre></div>
</div>
<p>3. Create symbolic link at Google Chrome’s default directory:</p>
<div class="highlight-shell-session"><div class="highlight"><pre><span class="go"># ln -s /usr/lib64/mozilla/plugins/libflashplayer.so /opt/google/chrome/libflashplayer.so</span>
</pre></div>
</div>
<ol class="arabic simple" start="4">
<li>Restart Google Chrome, go to “<a class="reference external" href="about:plugins">about:plugins</a>” page, toggle “Details” switch at upper right corner, disable PepperFlash plugin and enable the Adobe Flash Player plugin with location “/usr/lib64/flash-plugin/libflashplayer.so”</li>
</ol>
]]></description>
             <pubDate>Thu, 20 Mar 2014 00:00:00 -0700</pubDate>
        </item>
    
    </channel>
</rss>