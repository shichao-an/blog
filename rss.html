<?xml version="1.0" encoding="utf-8"?>
<rss version="2.0">
    <channel>
        <title>Shichao's Blog</title>
        <link>https://blog.shichao.io/</link>
        <description>Recording molecular stuff</description>
        <language>en-us</language>
        <pubDate>Wed, 22 Jul 2015 00:00:00 -0700</pubDate>
        
        <item>
            <link>https://blog.shichao.io/2015/07/22/relationships_among_nice_priority_and_weight_in_linux_kernel.html</link>
            <guid>https://blog.shichao.io/2015/07/22/relationships_among_nice_priority_and_weight_in_linux_kernel.html</guid>
            <title><![CDATA[Relationships among nice, priority and weight in Linux kernel]]></title>
            <description><![CDATA[<h1>Relationships among nice, priority and weight in Linux kernel</h1>
<div class="section" id="nice-value">
<h2>nice value</h2>
<p>On Linux, the nice value ranges from -20 to 19.</p>
</div>
<div class="section" id="nice-and-weight">
<h2>nice and weight</h2>
<p>In the Linux’s Completely Fair Scheduler (CFS), mapping of nice to weight of a process is critical to calculating the virtual runtime (<span class="docutils literal"><span class="pre">vruntime</span></span>) of its scheduler entity structure (<span class="docutils literal"><span class="pre">struct</span> <span class="pre">sched_entity</span></span>). In Linux 2.6.34, this is defined in <span class="docutils literal"><span class="pre">prio_to_weight</span></span> (<a class="reference external" href="https://github.com/torvalds/linux/blob/v2.6.34/kernel/sched.c#L1356">kernel/sched.c#L1356</a>). The weight is roughly equivalent to <span class="docutils literal"><span class="pre">1024/(1.25)^(nice)</span></span>:</p>
<div class="highlight-c"><div class="highlight"><pre><span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">prio_to_weight</span><span class="p">[</span><span class="mi">40</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
 <span class="cm">/* -20 */</span>     <span class="mi">88761</span><span class="p">,</span>     <span class="mi">71755</span><span class="p">,</span>     <span class="mi">56483</span><span class="p">,</span>     <span class="mi">46273</span><span class="p">,</span>     <span class="mi">36291</span><span class="p">,</span>
 <span class="cm">/* -15 */</span>     <span class="mi">29154</span><span class="p">,</span>     <span class="mi">23254</span><span class="p">,</span>     <span class="mi">18705</span><span class="p">,</span>     <span class="mi">14949</span><span class="p">,</span>     <span class="mi">11916</span><span class="p">,</span>
 <span class="cm">/* -10 */</span>      <span class="mi">9548</span><span class="p">,</span>      <span class="mi">7620</span><span class="p">,</span>      <span class="mi">6100</span><span class="p">,</span>      <span class="mi">4904</span><span class="p">,</span>      <span class="mi">3906</span><span class="p">,</span>
 <span class="cm">/*  -5 */</span>      <span class="mi">3121</span><span class="p">,</span>      <span class="mi">2501</span><span class="p">,</span>      <span class="mi">1991</span><span class="p">,</span>      <span class="mi">1586</span><span class="p">,</span>      <span class="mi">1277</span><span class="p">,</span>
 <span class="cm">/*   0 */</span>      <span class="mi">1024</span><span class="p">,</span>       <span class="mi">820</span><span class="p">,</span>       <span class="mi">655</span><span class="p">,</span>       <span class="mi">526</span><span class="p">,</span>       <span class="mi">423</span><span class="p">,</span>
 <span class="cm">/*   5 */</span>       <span class="mi">335</span><span class="p">,</span>       <span class="mi">272</span><span class="p">,</span>       <span class="mi">215</span><span class="p">,</span>       <span class="mi">172</span><span class="p">,</span>       <span class="mi">137</span><span class="p">,</span>
 <span class="cm">/*  10 */</span>       <span class="mi">110</span><span class="p">,</span>        <span class="mi">87</span><span class="p">,</span>        <span class="mi">70</span><span class="p">,</span>        <span class="mi">56</span><span class="p">,</span>        <span class="mi">45</span><span class="p">,</span>
 <span class="cm">/*  15 */</span>        <span class="mi">36</span><span class="p">,</span>        <span class="mi">29</span><span class="p">,</span>        <span class="mi">23</span><span class="p">,</span>        <span class="mi">18</span><span class="p">,</span>        <span class="mi">15</span><span class="p">,</span>
<span class="p">};</span>
</pre></div>
</div>
</div>
<div class="section" id="nice-and-priority">
<h2>nice and priority</h2>
<p>The conversion between nice and static priority (priority for <span class="docutils literal"><span class="pre">SCHED_NORMAL</span></span>, or non-“real-time” tasks) is defined by the <span class="docutils literal"><span class="pre">NICE_TO_PRIO</span></span> and <span class="docutils literal"><span class="pre">PRIO_TO_NICE</span></span> macros. Before Linux 3.15, for example, 2.6.34, this is defined in <a class="reference external" href="https://github.com/torvalds/linux/blob/v2.6.34/kernel/sched.c#L89">kernel/sched.c</a>; since Linux 3.15, it is defined in <a class="reference external" href="https://github.com/torvalds/linux/blob/v4.1/include/linux/sched/prio.h#L32">include/linux/sched/prio.h</a>. The relation is literally <span class="docutils literal"><span class="pre">prio</span> <span class="pre">=</span> <span class="pre">nice</span> <span class="pre">+</span> <span class="pre">120</span></span>, so the priority ranges from 100 to 139.</p>
<p>The following is the macro definition from the 2.6.34 source code</p>
<div class="highlight-c"><div class="highlight"><pre><span class="cp">#define NICE_TO_PRIO(nice)  (MAX_RT_PRIO + (nice) + 20)</span>
<span class="cp">#define PRIO_TO_NICE(prio)  ((prio) - MAX_RT_PRIO - 20)</span>
</pre></div>
</div>
</div>
<div class="section" id="nice-value-and-rlimit-style-value">
<h2>nice value and rlimit style value</h2>
<p>In the recent man page on <a class="reference external" href="http://man7.org/linux/man-pages/man2/setpriority.2.html">setpriority(2)</a>, there is a formula <span class="docutils literal"><span class="pre">unice</span> <span class="pre">=</span> <span class="pre">20</span> <span class="pre">-</span> <span class="pre">knice</span></span> that converts “user” nice values (-20..19) to “kernel” nice values (40..1), which is said to be handled by glibc wrapper functions for <span class="docutils literal"><span class="pre">setpriority()</span></span> and <span class="docutils literal"><span class="pre">getpriority()</span></span> system calls. This seems vague in definition.</p>
<p><a class="reference external" href="http://lxr.free-electrons.com/ident?v=3.16;i=nice_to_rlimit">Since Linux 3.16</a>, a new <cite>nice_to_rlimit</cite> function is added to <span class="docutils literal"><span class="pre">include/linux/sched/prio.h</span></span>, which seems to match the above description. This function converts nice value [19,-20] to rlimit style value [1,40]. The formula is equivalent to that on the man page. The <span class="docutils literal"><span class="pre">rlimit_to_nice</span></span> does the reverse operation.</p>
<div class="highlight-c"><div class="highlight"><pre><span class="k">static</span> <span class="kr">inline</span> <span class="kt">long</span> <span class="nf">nice_to_rlimit</span><span class="p">(</span><span class="kt">long</span> <span class="n">nice</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">MAX_NICE</span> <span class="o">-</span> <span class="n">nice</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Here, <span class="docutils literal"><span class="pre">MAX_NICE</span></span> is defined to be 19, so it is essentially <span class="docutils literal"><span class="pre">rlimit</span> <span class="pre">=</span> <span class="pre">20</span> <span class="pre">-</span> <span class="pre">nice</span></span>.</p>
<p>Note that the rlimit style value is not to be confused with “user priority” (<a class="reference external" href="https://github.com/torvalds/linux/blob/v4.1/include/linux/sched/prio.h#L40">include/linux/sched/prio.h#L40</a>), which has a range of 0 to 39.</p>
</div>
]]></description>
             <pubDate>Wed, 22 Jul 2015 00:00:00 -0700</pubDate>
        </item>
    
        <item>
            <link>https://blog.shichao.io/2015/05/21/setup_nss_ldapd_on_ubuntu_14_04.html</link>
            <guid>https://blog.shichao.io/2015/05/21/setup_nss_ldapd_on_ubuntu_14_04.html</guid>
            <title><![CDATA[Setting up nss-ldapd on Ubuntu 14.04]]></title>
            <description><![CDATA[<h1>Setting up nss-ldapd on Ubuntu 14.04</h1>
<p>The last few posts discussed <a class="reference external" href="https://blog.shichao.io/2015/04/17/setup_openldap_server_with_openssh_lpk_on_ubuntu">setting up an OpenLDAP server</a> and <a class="reference external" href="https://blog.shichao.io/2015/04/19/setup_openldap_client_server_with_ssh_access_on_ubuntu">configuring basic client server</a>. However, that client server uses <a class="reference external" href="http://packages.ubuntu.com/trusty/libnss-ldap">nss-ldap</a> with some known issues <a class="reference external" href="https://wiki.debian.org/LDAP/NSS#Configuring_LDAP_Authentication">as presented here</a>.  With this old and seemingly buggy setup, I simply can’t make <cite>nss_initgroups_ignoreuses</cite> option work to bypass querying the LDAP server when authenticating local or system users on the server, and have no idea what <span class="docutils literal"><span class="pre">nssldap-update-ignoreusers</span></span> command actually does. When the LDAP server is down or there is network issues connecting the LDAP server, the default configuration will simply block local users from logging in the server (at least for a long time until the query is considered timed out). Also, as I found after checking <span class="docutils literal"><span class="pre">/var/log/auth.log</span></span>, it queries the LDAP server even when doing a Bash completion, because it was very slow when I pressed the TAB key after a path name. Setting <cite>bind_policy</cite> option to soft and  <cite>timelimit</cite> and <cite>bind_timelimit</cite> to smaller values may just alleviate the symptom but does not solve the problem.</p>
<p>So I decide to use nss-ldapd that comes with the <span class="docutils literal"><span class="pre">libnss-ldapd</span></span> package.</p>
<div class="highlight-python"><div class="highlight"><pre>apt-get install libpam-ldap nscd ldap-utils libnss-ldapd
</pre></div>
</div>
<p>Running the above command will automatically remove the <span class="docutils literal"><span class="pre">libnss-ldap</span></span> package and prompt interacive post-install steps for you to configure the LDAP parameters. You can disable this interactive behavior and directly place your config in <span class="docutils literal"><span class="pre">/etc/nslcd.conf</span></span> with the following command:</p>
<div class="highlight-python"><div class="highlight"><pre>export DEBIAN_FRONTEND=noninteractive
apt-get -y install libpam-ldap nscd ldap-utils libnss-ldapd
</pre></div>
</div>
<p>Then, put your config in <span class="docutils literal"><span class="pre">/etc/nslcd.conf</span></span>:</p>
<div class="highlight-python"><div class="highlight"><pre>uid nslcd
gid nslcd
uri ldaps://ldap.example.com
base dc=example,dc=com
binddn cn=OpenLDAP Client,ou=users,dc=example,dc=com
bindpw password
tls_reqcert never
nss_initgroups_ignoreusers ALLLOCAL
bind_timelimit 3
timelimit 3
</pre></div>
</div>
<p>The last line <span class="docutils literal"><span class="pre">nss_initgroups_ignoreusers</span> <span class="pre">ALLLOCAL</span></span> prevents group membership lookups through LDAP for all local users.</p>
<p>The remaining settings for PAM, sudoers and access.conf are essentially the same as the old nss-ldap setup. Just make sure to restart the LDAP nameservice daemon, nslcd, after making changes to <span class="docutils literal"><span class="pre">/etc/nslcd.conf</span></span>:</p>
<div class="highlight-python"><div class="highlight"><pre>service nslcd restart
</pre></div>
</div>
<p>If nscd cache daemon is also enabled and you make some changes to the user from the LDAP, you may want to clear the cache:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">nscd</span> <span class="o">--</span><span class="n">invalidate</span><span class="o">=</span><span class="n">passwd</span>
<span class="n">nscd</span> <span class="o">--</span><span class="n">invalidate</span><span class="o">=</span><span class="n">group</span>
</pre></div>
</div>
<p>The nslcd daemon also has the advantage that it can be easily stopped in order to temporarily disable the LDAP lookup. This makes the management of LDAP access more easy.</p>
<p>Finally, here is the setup script:</p>
<ul class="simple">
<li><a class="reference external" href="https://gist.github.com/shichao-an/0e7fe33cc540797e3ee0">setup-nss-ldapd.sh</a></li>
</ul>
]]></description>
             <pubDate>Thu, 21 May 2015 00:00:00 -0700</pubDate>
        </item>
    
        <item>
            <link>https://blog.shichao.io/2015/04/22/auditing_user_tty_and_root_commands_with_auditd_on_ubuntu.html</link>
            <guid>https://blog.shichao.io/2015/04/22/auditing_user_tty_and_root_commands_with_auditd_on_ubuntu.html</guid>
            <title><![CDATA[Auditing user TTY and root commands with auditd on Ubuntu]]></title>
            <description><![CDATA[<h1>Auditing user TTY and root commands with auditd on Ubuntu</h1>
<p><span class="docutils literal"><span class="pre">auditd</span></span> can be used to track user commands executed in a TTY. If the system is a server and the user logins through SSH, the <span class="docutils literal"><span class="pre">pam_tty_audit</span></span> PAM module must be enabled in the PAM configuration for sshd (the following line must appear in <span class="docutils literal"><span class="pre">/etc/pam.d/sshd</span></span>):</p>
<div class="highlight-python"><div class="highlight"><pre>session required pam_tty_audit.so enable=*
</pre></div>
</div>
<p>Then, the audit report can be reviewed using the <span class="docutils literal"><span class="pre">aureport</span></span> command, e.g. tty keystrokes:</p>
<div class="highlight-shell-session"><div class="highlight"><pre><span class="go"># aureport --tty</span>
</pre></div>
</div>
<p>However, the above setup cannot audit users that switch to root using the <span class="docutils literal"><span class="pre">sudo</span> <span class="pre">su</span> <span class="pre">-</span></span> command. In order to audit all commands run by root, <a class="reference external" href="http://serverfault.com/questions/470755/log-all-commands-run-by-admins-on-production-servers">as referenced here</a>, the following two lines must be added to <span class="docutils literal"><span class="pre">/etc/audit/audit.rules</span></span>:</p>
<div class="highlight-text"><div class="highlight"><pre>-a exit,always -F arch=b64 -F euid=0 -S execve
-a exit,always -F arch=b32 -F euid=0 -S execve
</pre></div>
</div>
<p>And also make sure <span class="docutils literal"><span class="pre">pam_loginuid.so</span></span> is enabled in <span class="docutils literal"><span class="pre">/etc/pam.d/sshd</span></span> (default in Ubuntu 14.04).</p>
<p>In this way, all processes with euid 0 will be audited and their auid (audit user id, which represents the real user before <span class="docutils literal"><span class="pre">su</span></span>) will be preserved in the log. To check the audit log, for example about a user with uid 1000, the following command can be used:</p>
<div class="highlight-text"><div class="highlight"><pre>ausearch -ua 1000
</pre></div>
</div>
<p>The <span class="docutils literal"><span class="pre">audit.log</span></span> file is located at <span class="docutils literal"><span class="pre">/var/log/audit</span></span>.</p>
<p>Note that before auditing takes effect, the system needs reboot after either installing the <span class="docutils literal"><span class="pre">auditd</span></span> package or editing these configuration files. All above were tested on Ubuntu 14.04. Here is a script that can set all these up:</p>
<ul class="simple">
<li><a class="reference external" href="https://gist.github.com/shichao-an/f019f7b9ab51c271ad49">setup-audit.sh</a></li>
</ul>
]]></description>
             <pubDate>Wed, 22 Apr 2015 00:00:00 -0700</pubDate>
        </item>
    
        <item>
            <link>https://blog.shichao.io/2015/04/19/setup_openldap_client_server_with_ssh_access_on_ubuntu.html</link>
            <guid>https://blog.shichao.io/2015/04/19/setup_openldap_client_server_with_ssh_access_on_ubuntu.html</guid>
            <title><![CDATA[Setting up OpenLDAP client server with SSH access on Ubuntu 14.04]]></title>
            <description><![CDATA[<h1>Setting up OpenLDAP client server with SSH access on Ubuntu 14.04</h1>
<p>This post documents how to set up an OpenLDAP client server (Ubuntu 14.04) that can make its OpenSSH server to load authorized keys from a pre-configured OpenLDAP server with <span class="docutils literal"><span class="pre">ldaps://</span></span> available (discussed in the <a class="reference internal" href="https://blog.shichao.io/2015/04/17/setup_openldap_server_with_openssh_lpk_on_ubuntu.html"><em>previous post</em></a>, please read this first if you haven’t). Users are able to SSH access this client server, while their SSH public keys are stored on the OpenLDAP server. The SSH authentication process on the client server is mainly facilitated by <a class="reference external" href="https://github.com/jirutka/ssh-ldap-pubkey">ssh-ldap-pubkey</a>.</p>
<div class="section" id="script">
<h2>Script</h2>
<ul class="simple">
<li><a class="reference external" href="https://gist.github.com/shichao-an/9005314e10e9a8ffa865">setup-ldap-client.sh</a></li>
</ul>
</div>
<div class="section" id="install-packages">
<h2>Install packages</h2>
<div class="highlight-python"><div class="highlight"><pre>apt-get -y install libpam-ldap nscd ldap-utils
apt-get -y install python-pip python-ldap
# https://github.com/jirutka/ssh-ldap-pubkey
pip install ssh-ldap-pubkey
</pre></div>
</div>
</div>
<div class="section" id="configure-ssh-server">
<h2>Configure SSH server</h2>
<ul>
<li><p class="first">Add the following lines to <span class="docutils literal"><span class="pre">/etc/ssh/sshd_config</span></span>:</p>
<div class="highlight-python"><div class="highlight"><pre>AuthorizedKeysCommand /usr/local/bin/ssh-ldap-pubkey-wrapper
AuthorizedKeysCommandUser nobody
</pre></div>
</div>
</li>
<li><p class="first">Restart SSH server</p>
<div class="highlight-python"><div class="highlight"><pre>service ssh restart
</pre></div>
</div>
</li>
</ul>
</div>
<div class="section" id="configure-pam">
<h2>Configure PAM</h2>
<ul>
<li><p class="first">Edit <span class="docutils literal"><span class="pre">/etc/ldap.conf</span></span>:</p>
<div class="highlight-python"><div class="highlight"><pre>uri ldaps://ldap.example.com
binddn cn=OpenLDAP Client,ou=users,dc=example,dc=com
bindpw password
</pre></div>
</div>
</li>
<li><p class="first">Edit <span class="docutils literal"><span class="pre">/etc/pam.d/common-auth</span></span> and add the following line:</p>
<div class="highlight-python"><div class="highlight"><pre>account required    pam_access.so
</pre></div>
</div>
</li>
<li><p class="first">Edit <span class="docutils literal"><span class="pre">/etc/pam.d/common-password</span></span> and remove <span class="docutils literal"><span class="pre">use_authtok</span></span>
parameter</p>
</li>
<li><p class="first">Edit <span class="docutils literal"><span class="pre">/etc/pam.d/common-session</span></span> and add the following line:</p>
<div class="highlight-python"><div class="highlight"><pre>session required    pam_mkhomedir.so skel=/etc/skel umask=0022
</pre></div>
</div>
</li>
</ul>
</div>
<div class="section" id="configure-nss-login-access-control-and-sudo">
<h2>Configure NSS, login access control and sudo</h2>
<ul>
<li><p class="first">Edit <span class="docutils literal"><span class="pre">/etc/nsswitch.conf</span></span>:</p>
<div class="highlight-python"><div class="highlight"><pre>passwd:         compat ldap
group:          compat ldap
shadow:         compat ldap
</pre></div>
</div>
</li>
<li><p class="first">Edit <span class="docutils literal"><span class="pre">/etc/security/access.conf</span></span>, replace <span class="docutils literal"><span class="pre">ldap-team</span></span> with actual
group name:</p>
<div class="highlight-python"><div class="highlight"><pre>- : ALL EXCEPT root (admin) (wheel) (ldap-team): ALL EXCEPT LOCAL
</pre></div>
</div>
</li>
<li><p class="first">Edit <span class="docutils literal"><span class="pre">/etc/sudoers</span></span> using <span class="docutils literal"><span class="pre">visudo</span></span> command and add the following
lines. Replace <span class="docutils literal"><span class="pre">ldap-team</span></span> with actual group name:</p>
<div class="highlight-python"><div class="highlight"><pre>%ldap-team ALL=(ALL) ALL
</pre></div>
</div>
</li>
<li><p class="first">Restart nscd</p>
<div class="highlight-python"><div class="highlight"><pre>service nscd restart
</pre></div>
</div>
</li>
</ul>
</div>
]]></description>
             <pubDate>Sun, 19 Apr 2015 00:00:00 -0700</pubDate>
        </item>
    
        <item>
            <link>https://blog.shichao.io/2015/04/17/setup_openldap_server_with_openssh_lpk_on_ubuntu.html</link>
            <guid>https://blog.shichao.io/2015/04/17/setup_openldap_server_with_openssh_lpk_on_ubuntu.html</guid>
            <title><![CDATA[Setting up OpenLDAP server with OpenSSH-LPK on Ubuntu 14.04]]></title>
            <description><![CDATA[<h1>Setting up OpenLDAP server with OpenSSH-LPK on Ubuntu 14.04</h1>
<p>This post documents how to set up a secure OpenLDAP server that is able to make OpenLDAP client servers accept authorized SSH access requests from users.
The following steps assume the OpenLDAP server (slapd) and phpLDAPadmin are installed as referenced in the <a class="reference external" href="https://www.digitalocean.com/community/tutorials/how-to-install-and-configure-a-basic-ldap-server-on-an-ubuntu-12-04-vps">initial setup</a>.</p>
<div class="section" id="instructions-and-references">
<h2>Instructions and references</h2>
<ul class="simple">
<li><a class="reference external" href="https://www.digitalocean.com/community/tutorials/how-to-install-and-configure-a-basic-ldap-server-on-an-ubuntu-12-04-vps">Initial setup</a></li>
<li><a class="reference external" href="https://code.google.com/p/openssh-lpk/">OpenSSH-LPK</a> and <a class="reference external" href="https://github.com/jirutka/ssh-ldap-pubkey">ssh-ldap-pubkey</a> (on LDAP clients)</li>
<li><a class="reference external" href="http://lucor.github.io/post/ubuntu-and-ldap-force-authentication-during-a-bind-request/">Force authentication</a></li>
<li><a class="reference external" href="http://rogermoffatt.com/2011/08/24/ubuntu-openldap-with-ssltls/">Secure LDAP with SSL/TLS</a></li>
</ul>
</div>
<div class="section" id="understanding-cn-config-ldap-database">
<h2>Understanding cn=config (LDAP database)</h2>
<p>The default installation of OpenLDAP in recent versions of Ubuntu uses the new <a class="reference external" href="https://help.ubuntu.com/community/OpenLDAPServer#Installation">runtime configuration (RTC)
system</a> or olc (OpenLDAP Configuration). This installation uses <span class="docutils literal"><span class="pre">cn=config</span></span> (the LDAP database) for configuration rather than the old style <span class="docutils literal"><span class="pre">slapd.conf</span></span>.</p>
</div>
<div class="section" id="schemas">
<h2>Schemas</h2>
<p>The schemas can be imported dynamically into <span class="docutils literal"><span class="pre">cn=config</span></span> database, without restarting <span class="docutils literal"><span class="pre">slapd</span></span>. The schemas to be imported can placed in
<span class="docutils literal"><span class="pre">/etc/ldap/schema</span></span>.</p>
<p>The following schema in ldif format will be used and discussed in the subsequent sections:</p>
<ul class="simple">
<li><span class="docutils literal"><span class="pre">openssh-lpk.ldif</span></span></li>
<li><span class="docutils literal"><span class="pre">ldap_disable_bind_anon.ldif</span></span></li>
<li><span class="docutils literal"><span class="pre">ssl.ldif</span></span></li>
</ul>
</div>
<div class="section" id="importing-openssh-lpk-scheme">
<h2>Importing openssh-lpk scheme</h2>
<div class="highlight-python"><div class="highlight"><pre>ldapadd -Y EXTERNAL -H ldapi:/// -f openssh-lpk.ldif
</pre></div>
</div>
<p>where <span class="docutils literal"><span class="pre">openssh-lpk.ldif</span></span> is:</p>
<div class="highlight-python"><div class="highlight"><pre>dn: cn=openssh-lpk,cn=schema,cn=config
objectClass: olcSchemaConfig
cn: openssh-lpk
olcAttributeTypes: ( 1.3.6.1.4.1.24552.500.1.1.1.13 NAME 'sshPublicKey'
  DESC 'MANDATORY: OpenSSH Public key'
  EQUALITY octetStringMatch
  SYNTAX 1.3.6.1.4.1.1466.115.121.1.40 )
olcObjectClasses: ( 1.3.6.1.4.1.24552.500.1.1.2.0 NAME 'ldapPublicKey' SUP top AUXILIARY
  DESC 'MANDATORY: OpenSSH LPK objectclass'
  MAY ( sshPublicKey $ uid )
  )
</pre></div>
</div>
</div>
<div class="section" id="forcing-authentication">
<h2>Forcing authentication</h2>
<p>By default, OpenLDAP allows anonymous query from any client servers. You may want to enable authentication so that only authenticated clients are able to query the server:</p>
<div class="highlight-python"><div class="highlight"><pre>ldapadd -Y EXTERNAL -H ldapi:/// -f ldap_disable_bind_anon.ldif
</pre></div>
</div>
<p>where <span class="docutils literal"><span class="pre">ldap_disable_bind_anon.ldif</span></span> is:</p>
<div class="highlight-python"><div class="highlight"><pre>dn: cn=config
changetype: modify
add: olcDisallows
olcDisallows: bind_anon

dn: cn=config
changetype: modify
add: olcRequires
olcRequires: authc

dn: olcDatabase={-1}frontend,cn=config
changetype: modify
add: olcRequires
olcRequires: authc
</pre></div>
</div>
<p class="readmorewrapper"><a class="readmore" href="https://blog.shichao.io/2015/04/17/setup_openldap_server_with_openssh_lpk_on_ubuntu.html#more">Read more...</a></p></div>
 
 
 
 
 
 
 
]]></description>
             <pubDate>Fri, 17 Apr 2015 00:00:00 -0700</pubDate>
        </item>
    
        <item>
            <link>https://blog.shichao.io/2015/01/06/tunneling_rdp_over_ssh_with_xrdp_and_xfreerdp.html</link>
            <guid>https://blog.shichao.io/2015/01/06/tunneling_rdp_over_ssh_with_xrdp_and_xfreerdp.html</guid>
            <title><![CDATA[Tunneling RDP over SSH with xrdp and xfreerdp]]></title>
            <description><![CDATA[<h1>Tunneling RDP over SSH with xrdp and xfreerdp</h1>
<p>Suppose you have a remote desktop but you only have SSH access and you need to connect to that desktop with GUI. For example, you have a server at home and you’ve setup port forwarding on your router so that you can SSH to your that home server from office or school, and you don’t want to expose too many ports to the Internet. You can setup xrdp server and tunnel your connection over SSH.</p>
<p>In the following texts, the home server is Fedora 20 and the client laptop is OS X Yosemite.</p>
<div class="section" id="install-xrdp-on-home-server">
<h2>Install xrdp on home server</h2>
<p>On your home server, run:</p>
<div class="highlight-shell-session"><div class="highlight"><pre><span class="go"># yum install xrdp</span>
<span class="go"># systemctl start xrdp.service</span>
<span class="go"># systemctl enable xrdp.service</span>
</pre></div>
</div>
</div>
<div class="section" id="configure-firewall">
<h2>Configure firewall</h2>
<p>Add SSH service and open port 3389 to the current zone and make it permanent. By opening port 3389, you can connect directly to the home server without SSH when your laptop is in the same network at home.</p>
<div class="highlight-shell-session"><div class="highlight"><pre><span class="go"># firewall-cmd --add-service=ssh --permanent</span>
<span class="go"># firewall-cmd --add-port=3389/tcp --permanent</span>
<span class="go"># firewall-cmd --reload</span>
</pre></div>
</div>
</div>
<div class="section" id="install-xfreerdp-using-homebrew">
<h2>Install xfreerdp using homebrew</h2>
<p>Make sure you’ve installed XQuartz. You can download the dmg at <a class="reference external" href="http://xquartz.macosforge.org/landing/">http://xquartz.macosforge.org/landing/</a> .</p>
<p>On your OS X laptop:</p>
<div class="highlight-shell-session"><div class="highlight"><pre><span class="go">$ brew update</span>
<span class="go">$ brew install freerdp</span>
</pre></div>
</div>
</div>
<div class="section" id="start-ssh-forwarding">
<h2>Start SSH forwarding</h2>
<p>After you make sure you can SSH to your home server (say 1.1.1.1), you can start SSH forwarding. Run the following command in one terminal session:</p>
<div class="highlight-shell-session"><div class="highlight"><pre><span class="go">$ ssh -qnN -L 3389:127.0.0.1:3389 1.1.1.1</span>
</pre></div>
</div>
</div>
<div class="section" id="connect-to-home-server-using-xfreerdp">
<h2>Connect to home server using xfreerdp</h2>
<div class="highlight-shell-session"><div class="highlight"><pre><span class="go">$ xfreerdp localhost</span>
</pre></div>
</div>
<p>Then, you should have a X11 window show up as in the screenshot below. Enter your username and password to login to your home server.</p>
<p><a class="reference internal" href="https://blog.shichao.io/_images/xquartz-freerdp.png"><img alt="s1" src="https://blog.shichao.io/_images/xquartz-freerdp.png" style="width: 450px;"/></a></p>
</div>
]]></description>
             <pubDate>Tue, 06 Jan 2015 00:00:00 -0800</pubDate>
        </item>
    
        <item>
            <link>https://blog.shichao.io/2014/12/22/rabbitmq_clustering_and_high_availability_on_ubuntu_ec2_servers.html</link>
            <guid>https://blog.shichao.io/2014/12/22/rabbitmq_clustering_and_high_availability_on_ubuntu_ec2_servers.html</guid>
            <title><![CDATA[RabbitMQ clustering and high availability on Ubuntu EC2 servers]]></title>
            <description><![CDATA[<h1>RabbitMQ clustering and high availability on Ubuntu EC2 servers</h1>
<div class="section" id="sample">
<h2>Sample</h2>
<p>The following setup and configurations were performed on the production servers listed below:</p>
<ul class="simple">
<li>mq-node1.example.com</li>
<li>mq-node2.example.com</li>
<li>mq-node3.example.com</li>
</ul>
</div>
<div class="section" id="installation">
<h2>Installation</h2>
<div class="highlight-shell-session"><div class="highlight"><pre><span class="go"># apt-get install rabbitmq-server</span>
</pre></div>
</div>
</div>
<div class="section" id="hostname-and-etc-hosts">
<h2>Hostname and /etc/hosts</h2>
<p>On each server, the first priority of setup is hostname and <span class="docutils literal"><span class="pre">/etc/hosts</span></span> for internal IP addresses, which are used by RabbitMQ (Erlang) nodes. Use this script (<a class="reference external" href="https://gist.github.com/shichao-an/7c43e22c21c666f384ef">set-hostname.sh</a>) to set the hostname for the corresponding server with the command:</p>
<div class="highlight-text"><div class="highlight"><pre># ./set-hostname.sh -s mq-nodeN.example.com
</pre></div>
</div>
<p>Then, modify <span class="docutils literal"><span class="pre">/etc/hosts</span></span> so that it looks like this (e.g. on mq-node1.example.com):</p>
<div class="highlight-text"><div class="highlight"><pre>127.0.1.1 mq-node1.example.com mq-node1
10.0.1.101 mq-node2
10.0.1.102 mq-node3
</pre></div>
</div>
</div>
<div class="section" id="ports">
<h2>Ports</h2>
<p>Make sure port 5672 (AMQP) and 45000 (we’ll use this later) are open on each server.</p>
</div>
<div class="section" id="config-files">
<h2>Config files</h2>
<p>On each server, do the following:</p>
<p>Edit <span class="docutils literal"><span class="pre">/etc/rabbitmq/rabbitmq-env.conf</span></span> and add the following (port configuration):</p>
<div class="highlight-text"><div class="highlight"><pre>SERVER_START_ARGS="-kernel inet_dist_listen_min 45000 -kernel inet_dist_listen_max 45000"
</pre></div>
</div>
<p>Edit <span class="docutils literal"><span class="pre">/etc/rabbitmq/rabbitmq.config</span></span> and add the following (clustering configuration):</p>
<div class="highlight-text"><div class="highlight"><pre>[{rabbit,
[{cluster_nodes, {['rabbit@mq-node1', 'rabbit@mq-node2', 'rabbit@mq-node3'], disc}}]}].
</pre></div>
</div>
<p>Edit <span class="docutils literal"><span class="pre">/var/lib/rabbitmq/.erlang.cookie</span></span> and make sure they are the same on each server.</p>
</div>
<div class="section" id="reset-and-start-nodes">
<h2>Reset and start nodes</h2>
<p>The RabbitMQ nodes may be already in running state. To put new configuration in effect, we have to reset and restart:
First, we reset and stop each node:</p>
<div class="highlight-shell-session"><div class="highlight"><pre><span class="go"># rabbitmqctl stop_app; rabbitmqctl reset;  rabbitmqctl stop</span>
</pre></div>
</div>
<p>Then, start each node in turn. Remember, do this IN TURN, not simultaneously:</p>
<div class="highlight-shell-session"><div class="highlight"><pre><span class="go"># service rabbitmq start</span>
</pre></div>
</div>
<p class="readmorewrapper"><a class="readmore" href="https://blog.shichao.io/2014/12/22/rabbitmq_clustering_and_high_availability_on_ubuntu_ec2_servers.html#more">Read more...</a></p></div>
 
 
 
 
 
 
 
 
]]></description>
             <pubDate>Mon, 22 Dec 2014 00:00:00 -0800</pubDate>
        </item>
    
        <item>
            <link>https://blog.shichao.io/2014/12/18/serving_local_filesystem_using_nginx_on_os_x.html</link>
            <guid>https://blog.shichao.io/2014/12/18/serving_local_filesystem_using_nginx_on_os_x.html</guid>
            <title><![CDATA[Serving local filesystem using nginx on OS X]]></title>
            <description><![CDATA[<h1>Serving local filesystem using nginx on OS X</h1>
<p>Sometimes you may want to access certain files on one computer from other LAN clients using web browsers, for example, a directory of PDF files, or some MP4/MOV videos that can be easily streamed through <a class="reference external" href="http://www.w3schools.com/html/html5_video.asp">HTML5 Video</a>.</p>
<p>To make things easy, we can set up an nginx server with <a class="reference external" href="https://github.com/aperezdc/ngx-fancyindex">Nginx Fancy Index module</a> to serve certain directories on one or more filesystems on your OS X system.</p>
<p>We can install all required software using homebrew and we need to do some hacks on the forumla. The following setup were tested on OS X 10.10.</p>
<p>First, tap <a class="reference external" href="https://github.com/Homebrew/homebrew-nginx">homebrew-nginx</a>:</p>
<div class="highlight-shell-session"><div class="highlight"><pre><span class="go">$ brew tap homebrew/nginx</span>
</pre></div>
</div>
<p>As of writing, the version of fancyindex-nginx-module provided by this formula is 0.3.2, but we need 0.3.3 which <a class="reference external" href="http://wiki.nginx.org/NgxFancyIndex">allows sorting elements by name (default), modification time</a>. So we need to edit the formula file:</p>
<div class="highlight-shell-session"><div class="highlight"><pre><span class="go">$ brew edit fancyindex-nginx-module</span>
</pre></div>
</div>
<p>Or, use a text editor to open the formula file:</p>
<div class="highlight-shell-session"><div class="highlight"><pre><span class="go">$ vim /usr/local/Library/Taps/homebrew/homebrew-nginx/Formula/fancyindex-nginx-module.rb</span>
</pre></div>
</div>
<p>and change <span class="docutils literal"><span class="pre">https://github.com/aperezdc/ngx-fancyindex/archive/v0.3.2.tar.gz</span></span> into <span class="docutils literal"><span class="pre">https://github.com/aperezdc/ngx-fancyindex/archive/v0.3.3.tar.gz</span></span>.</p>
<p>Then, install nginx by building with the Fancy Index Module:</p>
<div class="highlight-shell-session"><div class="highlight"><pre><span class="go">$ brew install nginx-full --with-fancyindex-module</span>
</pre></div>
</div>
<p>If brew complains about SHA1 error, then you have to modify the <span class="docutils literal"><span class="pre">sha1</span></span> value of the previous fomula to match the actual sha1 in the error output.</p>
<p>Download <a class="reference external" href="https://github.com/TheInsomniac/Nginx-Fancyindex-Theme">FancyIndex Theme</a> to <span class="docutils literal"><span class="pre">/usr/local/etc/nginx/fancyindex</span></span>:</p>
<div class="highlight-shell-session"><div class="highlight"><pre><span class="go">$ git clone https://github.com/TheInsomniac/Nginx-Fancyindex-Theme.git /usr/local/etc/nginx/fancyindex</span>
</pre></div>
</div>
<p>All that remains to be done is configuration. Assume you want to serve <span class="docutils literal"><span class="pre">/path/to/movies</span></span> and <span class="docutils literal"><span class="pre">/another/path/to/pdf</span></span> directories, you can use alias <span class="docutils literal"><span class="pre">movies</span></span> and <span class="docutils literal"><span class="pre">pdf</span></span> to point to these locations. Edit <span class="docutils literal"><span class="pre">/usr/local/etc/nginx/nginx.conf</span></span> and modify the <span class="docutils literal"><span class="pre">server</span></span> block under <span class="docutils literal"><span class="pre">http</span></span> block:</p>
<div class="highlight-nginx"><div class="highlight"><pre><span class="k">server</span> <span class="p">{</span>
    <span class="kn">listen</span>       <span class="mi">8080</span><span class="p">;</span>
    <span class="kn">server_name</span>  <span class="s">localhost</span><span class="p">;</span>

    <span class="kn">fancyindex</span> <span class="no">on</span><span class="p">;</span>
    <span class="kn">fancyindex_exact_size</span> <span class="no">off</span><span class="p">;</span>
    <span class="kn">fancyindex_localtime</span> <span class="no">on</span><span class="p">;</span>
    <span class="kn">fancyindex_header</span> <span class="s">"/fancyindex/header.html"</span><span class="p">;</span>
    <span class="kn">fancyindex_footer</span> <span class="s">"/fancyindex/footer.html"</span><span class="p">;</span>
    <span class="kn">fancyindex_ignore</span> <span class="s">"fancyindex"</span><span class="p">;</span>

    <span class="kn">location</span> <span class="s">/movies</span> <span class="p">{</span>
        <span class="kn">alias</span> <span class="s">/path/to/movies/</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kn">location</span> <span class="s">/pdf</span> <span class="p">{</span>
        <span class="kn">alias</span> <span class="s">/another/path/to/pdf/</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kn">location</span> <span class="s">/fancyindex/</span> <span class="p">{</span>
        <span class="kn">alias</span> <span class="s">/usr/local/etc/nginx/fancyindex/</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The config above is just a minimum configuration. You may add extra configurations (e.g. <span class="docutils literal"><span class="pre">error_log</span></span>, <span class="docutils literal"><span class="pre">error_page</span></span>) according to your need. Note the paths for the <span class="docutils literal"><span class="pre">alias</span></span> directives, there must be trailing slashes, such as <span class="docutils literal"><span class="pre">alias</span> <span class="pre">/path/to/movies/</span></span>.</p>
<p>Start nginx:</p>
<div class="highlight-shell-session"><div class="highlight"><pre><span class="go">$ nginx</span>
</pre></div>
</div>
<p>If you make any changes to the <span class="docutils literal"><span class="pre">nginx.conf</span></span>, remember to reload:</p>
<div class="highlight-shell-session"><div class="highlight"><pre><span class="go">$ nginx -s reload</span>
</pre></div>
</div>
<p>You can check whether the port 8080 is in the LISTEN state:</p>
<div class="highlight-shell-session"><div class="highlight"><pre><span class="go">$ sudo netstat -anf inet -p tcp | grep LISTEN</span>
</pre></div>
</div>
<p>Finally, if you want to keep your firewall on and nginx trusted, run the following command:</p>
<div class="highlight-shell-session"><div class="highlight"><pre><span class="go">$ brew install coreutils  # for greadlink command</span>
<span class="go">$ sudo /usr/libexec/ApplicationFirewall/socketfilterfw --add $(greadlink -f /usr/local/bin/nginx)</span>
</pre></div>
</div>
<p>You can test from local <a class="reference external" href="http://127.0.0.1:8080/movies">http://127.0.0.1:8080/movies</a> as well as <a class="reference external" href="http://youripaddress:8080/movies">http://youripaddress:8080/movies</a> and <a class="reference external" href="http://youripaddress:8080/pdf">http://youripaddress:8080/pdf</a> from a browser on your LAN clients.</p>
<p><a class="reference internal" href="https://blog.shichao.io/_images/nginx-fancyindex.png"><img alt="s1" src="https://blog.shichao.io/_images/nginx-fancyindex.png" style="width: 450px;"/></a></p>
]]></description>
             <pubDate>Thu, 18 Dec 2014 00:00:00 -0800</pubDate>
        </item>
    
        <item>
            <link>https://blog.shichao.io/2014/10/01/setup_virtualenvwrapper_with_pyenv_using_pyenv_virtualenvwrapper.html</link>
            <guid>https://blog.shichao.io/2014/10/01/setup_virtualenvwrapper_with_pyenv_using_pyenv_virtualenvwrapper.html</guid>
            <title><![CDATA[Setting up virtualenvwrapper with pyenv using pyenv-virtualenvwrapper]]></title>
            <description><![CDATA[<h1>Setting up virtualenvwrapper with pyenv using pyenv-virtualenvwrapper</h1>
<p>Typically on OS X, I’m prone to use <a class="reference external" href="https://github.com/yyuu/pyenv">pyenv</a> to manage multiple Python versions, particularly 2.7 and 3.3. I always keep the 2.7.x Python (system version) that ships with OS X, and install extra versions using pyenv, and develop under virtualenvs. It seems <a class="reference external" href="https://github.com/pypa/virtualenv/">virtualenv</a> and <a class="reference external" href="https://bitbucket.org/dhellmann/virtualenvwrapper/">virtualenvwrapper</a> do not natively work well with pyenv’s shims when creating new virtualenvs, and it also seems the author of pyenv already gives the solution, <a class="reference external" href="https://github.com/yyuu/pyenv-virtualenvwrapper">pyenv-virtualenvwrapper</a>.</p>
<p>As an essential record, install Python 3.4.1 using pyenv (for installation of pyenv itself, see its <a class="reference external" href="https://github.com/yyuu/pyenv">documentation</a>) and enable it globally, along with the system version.</p>
<div class="highlight-shell-session"><div class="highlight"><pre><span class="go">$ pyenv install 3.4.1</span>
<span class="go">$ pyenv rehash</span>
<span class="go">$ pyenv global system 3.4.1</span>
</pre></div>
</div>
<p>You can verify current available versions using the following command:</p>
<div class="highlight-shell-session"><div class="highlight"><pre><span class="go">$ pyenv versions</span>
<span class="go">* system (set by /Users/shichao/.python-version)</span>
<span class="go">* 3.4.1 (set by /Users/shichao/.python-version)</span>
</pre></div>
</div>
<p>Make sure you have installed virtualenvwrapper and pyenv-virtualenvwrapper (using brew, of course):</p>
<div class="highlight-shell-session"><div class="highlight"><pre><span class="go">$ pip install virtualenvwrapper</span>
<span class="go">$ brew install pyenv-virtualenvwrapper</span>
</pre></div>
</div>
<p>Then, put the following lines somewhere in your <span class="docutils literal"><span class="pre">~/.bash_profile</span></span>:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="c"># pyenv</span>
<span class="nb">eval</span> <span class="s2">"</span><span class="k">$(</span>pyenv init -<span class="k">)</span><span class="s2">"</span>
<span class="c"># virtualenvwrapper</span>
<span class="nb">export </span><span class="nv">WORKON_HOME</span><span class="o">=</span>~/envs
</pre></div>
</div>
<p>Then you can enable virtualenvwrapper with <span class="docutils literal"><span class="pre">pyenv</span> <span class="pre">virtualenvwrapper</span></span>, and you may set an alias for that.</p>
<p>Now, you can normally create new virtualenvs.</p>
<p>Create a virtualenv from the system version:</p>
<div class="highlight-shell-session"><div class="highlight"><pre><span class="go">$ mkvirtualenv env1 -p $(which python)</span>
</pre></div>
</div>
<p>Similarly, create a virtualenv from 3.4:</p>
<div class="highlight-shell-session"><div class="highlight"><pre><span class="go">$ mkvirtualenv env2 -p $(which python3.4)</span>
</pre></div>
</div>
]]></description>
             <pubDate>Wed, 01 Oct 2014 00:00:00 -0700</pubDate>
        </item>
    
        <item>
            <link>https://blog.shichao.io/2014/05/02/fixing_mongodb_against_unclean_shutdown.html</link>
            <guid>https://blog.shichao.io/2014/05/02/fixing_mongodb_against_unclean_shutdown.html</guid>
            <title><![CDATA[Fixing MongoDB against unclean shutdown]]></title>
            <description><![CDATA[<h1>Fixing MongoDB against unclean shutdown</h1>
<p>It’s been a while since I maintained one of my servers that host an old project. After I got an HTTP 500 in an occasional case, I logged in to check what happened, only to find MongoDB is down. Running <span class="docutils literal"><span class="pre">service</span> <span class="pre">mongod</span> <span class="pre">restart</span></span> does not work. The MongoDB log indicates “Unclean shutdown detected.”</p>
<p>After a search on Google, here’s what I did to fix that:</p>
<div class="highlight-shell-session"><div class="highlight"><pre><span class="go"># grep dbpath /etc/mongod.conf</span>
<span class="go">dbpath=/var/lib/mongo</span>
<span class="go"># rm /var/lib/mongo/mongod.lock</span>
<span class="go"># mongod --repair --dbpath /var/lib/mongo</span>
</pre></div>
</div>
<p>At this point, you will see that MongoDB is running the repair process. If you immediately start MongoDB server after that, it still fails, because some permissions in /var/lib/mongo have been changed. You have to recover owner and group of those files back to “mongod” and then start the service:</p>
<div class="highlight-shell-session"><div class="highlight"><pre><span class="go"># chown -R mongod:mongod /var/lib/mongo</span>
<span class="go"># service mongod restart</span>
</pre></div>
</div>
<p>Finally note that this is an CentOS server. If you use MongoDB on Ubuntu, some namings may be different.</p>
]]></description>
             <pubDate>Fri, 02 May 2014 00:00:00 -0700</pubDate>
        </item>
    
    </channel>
</rss>